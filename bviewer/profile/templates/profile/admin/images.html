{% extends 'admin/base_site.html' %}
{% load admin_static %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static "admin/js/jquery.min.js" %}" type="text/javascript"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js" type="text/javascript"></script>
{% endblock %}


{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}"/>
    <style type="text/css">
        .split-path {
            font-size: 14px;
            font-style: italic;
        }

        .thumbnails {
            list-style: none;
        }

        .thumbnails li {
            position: relative;
            float: left;
            margin: 4px;
            list-style: none;
        }

        .thumbnails .caption {
            position: absolute;
            font-size: 11px;
            text-align: center;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            color: #666;
        }

        .thumbnails .image .caption {
            background: rgba(0, 0, 0, 0.7);
        }

        .thumbnails::after {
            clear: both;
        }

        .thumbnail img {
            width: 150px;
            height: 150px;
        }

        .thumbnail input[type=checkbox] {
            position: absolute;
            right: 0;
            margin: 2px;
        }
    </style>
{% endblock %}


{% block content %}
    <h1>Change Images</h1>

    <div id="content-main">
        <div class="module aligned">
            <div class="form-row">
                <label for="id_gallery" class="required">Gallery:</label>
                <select id="id_gallery" data-bind="options: galleries, optionsText: 'name', value: chosenGallery, optionsCaption: 'Choose...'"></select>
                <span data-bind="text: chosenGalleryId()"></span>
            </div>

            <div class="form-row">
                <label>Path:</label>

                <div class="split-path" data-bind="foreach: splitPath">
                    â€º <a href="#" class="label" data-bind="text: name, click: $parent.select"></a>
                </div>
            </div>

            <div class="form-row">
                <label class="required" style="float: none;">Folder:</label>
                <ul class="thumbnails">
                    <li data-bind="click: selectBack">
                        <a href="#" class="thumbnail">
                            <img src="{% static "core/img/gallery.png" %}">

                            <p class="caption">back</p>
                        </a>
                    </li>
                    <span data-bind="foreach: dirs">
                        <li data-bind="click: $parent.select">
                            <a href="#" class="thumbnail">
                                <img src="{% static "core/img/gallery.png" %}">

                                <p class="caption" data-bind="text: name"></p>
                            </a>
                        </li>
                    </span>
                    <span data-bind="foreach: files">
                        <li>
                            <a class="thumbnail image" data-bind="event: { mouseover: focusIn, mouseout: focusOut }">
                                <input type='checkbox' name="images" class="caption-checkbox" data-bind="checked: checked">
                                <img src data-bind="attr: { src: url }">

                                <p class="caption" data-bind="text: name, visible: underFocus"></p>
                            </a>
                        </li>
                    </span>
                </ul>
            </div>

            <div class="form-row">
                <label>Selected:</label>

                <div data-bind="text: selectedImages"></div>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        var Gallery = function (id, name) {
            var self = this;
            self.id = id;
            self.name = name;
        };

        var File = function (name, path, checked) {
            var self = this;
            self.name = name;
            self.path = path;
            self.checked = ko.observable(checked);
            self.url = "{% url profile.image %}?p=" + path;

            self.underFocus = ko.observable(false);
            self.focusIn = function () {
                self.underFocus(true);
            };
            self.focusOut = function () {
                self.underFocus(false);
            };
        };

        var ImageModel = function () {
            var self = this;
            self.galleries = ko.observableArray([
                new Gallery(1, 'Welcome'),
                new Gallery(2, 'Test')
            ]);

            self.chosenGallery = ko.observable();
            self.chosenGalleryId = ko.computed(function () {
                return self.chosenGallery() ? self.chosenGallery().id : '';
            });

            self.back = ko.observable('');
            self.path = ko.observable('');

            self.splitPath = ko.observableArray();
            self.dirs = ko.observableArray();
            self.files = ko.observableArray();

            self.selectedImages = ko.computed(function () {
                return ko.utils.arrayFilter(self.files(), function (file) {
                    return file.checked();
                }).length;
            });

            self.select = function (item) {
                self.loadFolder(item.path)
            };
            self.selectBack = function () {
                self.loadFolder(self.back());
            };
            self.loadFolder = function (path) {
                jQuery.getJSON("{% url profile.storage %}?p=" + path, function (data) {
                    self.path(data.path);
                    self.back(data.back);

                    var splitPath = jQuery.map(data.split_path, function (item) {
                        return { 'name': item.name, 'path': item.path };
                    });
                    self.splitPath(splitPath);

                    var dirs = jQuery.map(data.dirs, function (item) {
                        return new File(item.name, item.path);
                    });
                    self.dirs(dirs);
                    var files = jQuery.map(data.files, function (item) {
                        return new File(item.name, item.path, item.checked);
                    });
                    self.files(files);
                })
            };

            self.loadFolder('');

        };

        ko.applyBindings(new ImageModel());
    </script>
{% endblock %}


