{% extends 'core/base.html' %}
{% load staticfiles %}

{% block title %}Slideshow{% endblock %}

{% block main %}
    <div class="message">
        <h1>Slideshow</h1>

        <p>Click to start slide show</p>

        <button onclick="start();">Start</button>
    </div>
{% endblock %}

{% block media %}
    {{ block.super }}
    <link id="shadowbox.css" href="{% static 'core/css/shadowbox.css' %}" rel="stylesheet" type="text/css">
    <script id="shadowbox.js" src="{% static 'core/js/shadowbox.min.js' %}" type="text/javascript"></script>
    <script id="shadowbox.js" src="{% static 'core/js/core.js' %}" type="text/javascript"></script>

    <script type="text/javascript">
        core.initCSRF();

        var link = {{ link|safe }};

        function start() {
            var START = true;
            var settings = {
                overlayOpacity: 0.95,
                viewportPadding: 32,
                displayNav: false,
                //enableKeys: false,
                fadeDuration: 1.0,
                resizeDuration: 0.4,
                onClose: function () {
                    START = false;
                }
            };
            Shadowbox.init(settings);

            function initSlideShow(callback) {
                jQuery.ajax({
                    url: link.detail,
                    complete: function (data) {
                        if (data.status == 200) {
                            callback();
                        }
                        if (data.status == 404) {
                            jQuery.ajax({
                                type: 'POST',
                                url: link.root,
                                contentType: 'application/json',
                                data: '{"gallery_id": "{{ main.id }}"}',
                                complete: function (data) {
                                    callback();
                                }
                            });
                        }
                    }
                });
            }

            function loadImage() {
                jQuery.ajax({
                    url: link.next,
                    complete: function (response) {
                        var data = response.responseJSON;
                        var a = document.createElement('a');
                        a.href = data.link;
                        a.rel = 'shadowbox[videos]';
                        a.title = data.title;
                        var obj = Shadowbox.makeObject(a);
                        Shadowbox.gallery = [obj];
                        if (Shadowbox.isOpen()) {
                            Shadowbox.change(0);
                        } else {
                            Shadowbox.open(obj);
                        }
                    }
                });
            }

            var interval = window.setInterval(function () {
                if (START == true) loadImage();
            }, 10000);

            jQuery('body').delegate('#sb-body', 'click', function (e) {
                loadImage();
            });

            initSlideShow(loadImage);
        }
    </script>
{% endblock %}